<!--/***************************************************************************
//
//    softProjector - an open source media projection software
//    Copyright (C) 2023  Vladislav Kobzar
//
//    This program is free software: you can redistribute it and/or modify
//    it under the terms of the GNU General Public License as published by
//    the Free Software Foundation version 3 of the License.
//
//    This program is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License
//    along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
***************************************************************************/-->

<html>
<head>
    <title></title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Style for projector
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=block');
        * {
            margin: 0;
            padding: 0p;
        }
        body {
            width: 1860px;
            height: 1040px;
            padding: 20px 30px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
        }

        p {
            margin: 0;
            color: #fff;
            text-shadow: 3px 3px 1px #000;
            white-space: pre-wrap; /* For the line breaks in song text */
        }

        #bible, #song {
            display: flex;
            flex-direction: column;
            height: 1040px;
            width: 1860px;
        }

        #bible #primary,
        #bible #secondary {
            flex-basis: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 520px;
            width: 1860px;
        }

        #bible .text {
            margin-bottom: 8px;
        }

        #bible .reference {
            text-align: right;
            font-size: 70px;
        }

        #song {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #song .textFitted {
            /* Last indicator position */
            position: relative;
            height: 100%;
            display: flex !important;
            align-items: center;
        }

        #last-indicator {
            position: absolute;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: -1;
            font-size: 0.6em;
        }
    </style>-->


    <!-- Style for stream (lower third)
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400,700&display=block');
        * {
            margin: 0;
            padding: 0p;
        }
        body {
            width: 1860px;
            height: 1040px;
            padding: 20px 30px;
            font-family: 'Roboto', sans-serif;
            display: flex;
        }

        p {
            margin: 0;
            color: #fff;
            text-shadow: 3px 3px 1px #000;
        }

        #primary {
            display: none;
        }

        #bible, #song {
            align-self: flex-end;
            display: flex;
            flex-direction: column;
        }

        #bible #secondary {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 416px;
            width: 1860px;
        }

        #bible {
            height: 416px;
            width: 1860px;
            font-weight: 700;
        }

        #bible p {
            white-space: pre-wrap;
        }

        #bible .text {
            margin-bottom: 8px;
        }

        #bible .reference {
            text-align: right;
            font-size: 60px;
        }

        #song {
            height: 1040px;
            width: 1860px;
            font-weight: 400;
            letter-spacing: 2px;
        }

        #song.full-verse {
           justify-content: flex-end;
           letter-spacing: 4px;
        }

        #song.full-verse p {
            white-space: pre-wrap;
            line-height: 55px;
        }

        #song.verse-split .text {
            padding-top: 750px;
            text-align: center;
        }

        #song.verse-split p {
            white-space: pre;
            line-height: 1.1;
        }

        #last-indicator {
            display: none;
        }
    </style> -->
</head>
<body>
    <div id="bible">
        <div id="primary">
            <p class="text">&nbps;&nbps;&nbps;&nbps;</p>
            <p class="reference">&nbps;&nbps;</p>
        </div>
        <div id="secondary">
            <p class="text">&nbps;&nbps;&nbps;&nbps;</p>
            <p class="reference">&nbps;&nbps;</p>
        </div>
    </div>
    <div id="song">
        <p class="text"></p>
        <p id="last-indicator" style="visibility: hidden;">*&nbsp;&nbsp;*&nbsp;&nbsp;*</p>
    </div>

    <script>(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.textFit=factory()}})(typeof global==="object"?global:this,function(){"use strict";var defaultSettings={alignVert:false,alignHoriz:false,multiLine:false,detectMultiLine:true,minFontSize:6,maxFontSize:80,reProcess:true,widthOnly:false,alignVertWithFlexbox:false};return function textFit(els,options){if(!options)options={};var settings={};for(var key in defaultSettings){if(options.hasOwnProperty(key)){settings[key]=options[key]}else{settings[key]=defaultSettings[key]}}if(typeof els.toArray==="function"){els=els.toArray()}var elType=Object.prototype.toString.call(els);if(elType!=="[object Array]"&&elType!=="[object NodeList]"&&elType!=="[object HTMLCollection]"){els=[els]}for(var i=0;i<els.length;i++){processItem(els[i],settings)}};function processItem(el,settings){if(!isElement(el)||!settings.reProcess&&el.getAttribute("textFitted")){return false}if(!settings.reProcess){el.setAttribute("textFitted",1)}var innerSpan,originalHeight,originalHTML,originalWidth;var low,mid,high;originalHTML=el.innerHTML;originalWidth=innerWidth(el);originalHeight=innerHeight(el);if(!originalWidth||!settings.widthOnly&&!originalHeight){if(!settings.widthOnly)throw new Error("Set a static height and width on the target element "+el.outerHTML+" before using textFit!");else throw new Error("Set a static width on the target element "+el.outerHTML+" before using textFit!")}if(originalHTML.indexOf("textFitted")===-1){innerSpan=document.createElement("span");innerSpan.className="textFitted";innerSpan.style["display"]="inline-block";innerSpan.innerHTML=originalHTML;el.innerHTML="";el.appendChild(innerSpan)}else{innerSpan=el.querySelector("span.textFitted");if(hasClass(innerSpan,"textFitAlignVert")){innerSpan.className=innerSpan.className.replace("textFitAlignVert","");innerSpan.style["height"]="";el.className.replace("textFitAlignVertFlex","")}}if(settings.alignHoriz){el.style["text-align"]="center";innerSpan.style["text-align"]="center"}var multiLine=settings.multiLine;if(settings.detectMultiLine&&!multiLine&&innerSpan.scrollHeight>=parseInt(window.getComputedStyle(innerSpan)["font-size"],10)*2){multiLine=true}if(!multiLine){el.style["white-space"]="nowrap"}low=settings.minFontSize;high=settings.maxFontSize;var size=low;while(low<=high){mid=high+low>>1;innerSpan.style.fontSize=mid+"px";if(innerSpan.scrollWidth<=originalWidth&&(settings.widthOnly||innerSpan.scrollHeight<=originalHeight)){size=mid;low=mid+1}else{high=mid-1}}if(innerSpan.style.fontSize!=size+"px")innerSpan.style.fontSize=size+"px";if(settings.alignVert){addStyleSheet();var height=innerSpan.scrollHeight;if(window.getComputedStyle(el)["position"]==="static"){el.style["position"]="relative"}if(!hasClass(innerSpan,"textFitAlignVert")){innerSpan.className=innerSpan.className+" textFitAlignVert"}innerSpan.style["height"]=height+"px";if(settings.alignVertWithFlexbox&&!hasClass(el,"textFitAlignVertFlex")){el.className=el.className+" textFitAlignVertFlex"}}}function innerHeight(el){var style=window.getComputedStyle(el,null);return el.clientHeight-parseInt(style.getPropertyValue("padding-top"),10)-parseInt(style.getPropertyValue("padding-bottom"),10)}function innerWidth(el){var style=window.getComputedStyle(el,null);return el.clientWidth-parseInt(style.getPropertyValue("padding-left"),10)-parseInt(style.getPropertyValue("padding-right"),10)}function isElement(o){return typeof HTMLElement==="object"?o instanceof HTMLElement:o&&typeof o==="object"&&o!==null&&o.nodeType===1&&typeof o.nodeName==="string"}function hasClass(element,cls){return(" "+element.className+" ").indexOf(" "+cls+" ")>-1}function addStyleSheet(){if(document.getElementById("textFitStyleSheet"))return;var style=[".textFitAlignVert{","position: absolute;","top: 0; right: 0; bottom: 0; left: 0;","margin: auto;","display: flex;","justify-content: center;","flex-direction: column;","}",".textFitAlignVertFlex{","display: flex;","}",".textFitAlignVertFlex .textFitAlignVert{","position: static;","}"].join("");var css=document.createElement("style");css.type="text/css";css.id="textFitStyleSheet";css.innerHTML=style;document.body.appendChild(css)}});</script>

    <script type="text/javascript">
        var wsUri = "ws://${ipAddress}:${webSocketPort}";
        var websocket = null;

        function clearText() {
            document.querySelector("#bible #primary .text").textContent = "";
            document.querySelector("#bible #primary .reference").textContent = "";
            document.querySelector("#bible #secondary .text").textContent = "";
            document.querySelector("#bible #secondary .reference").textContent = "";
            document.querySelector("#song .text").textContent = "";
            document.querySelector("#song #last-indicator").style.visibility = "hidden";
            document.querySelector("#song").classList.remove("full-verse", "verse-split");
            document.querySelector("#bible").style.display = "none";
            document.querySelector("#song").style.display = "none";
        }

        function displayBible(bible) {
            document.querySelector("#bible").style.display = "flex";
            if (window.getComputedStyle(document.querySelector('#primary')).display !== 'none') {
                document.querySelector("#bible #primary .text").textContent = bible.primary.verse;
                document.querySelector("#bible #primary .reference").textContent = bible.primary.reference;
                textFit(document.querySelector('#primary'), {maxFontSize: 82});
            }
            if (window.getComputedStyle(document.querySelector('#secondary')).display !== 'none') {
                document.querySelector("#bible #secondary .text").textContent = bible.secondary.verse;
                document.querySelector("#bible #secondary .reference").textContent = bible.secondary.reference;
                textFit(document.querySelector('#secondary'), {maxFontSize: 82});
            }
        }

        function displaySong(song) {
            document.querySelector("#song").style.display = "flex";
            if (window.getComputedStyle(document.querySelector('#last-indicator')).display !== 'none') {
                // Projector styling.
                document.querySelector("#song .text").textContent = song.stanza;
                textFit(document.querySelector('#song'), {maxFontSize: 95});
                document.querySelector("#song #last-indicator").style.visibility = (!!song.isLast ? "visible" : "hidden");
            } else if (song.split.length != 0) {
                // Lower-thirds styling for verse split.
                document.querySelector("#song").classList.add("verse-split");
                document.querySelector("#song .text").textContent = song.split;
                textFit(document.querySelector('#song'), {maxFontSize: 65});
            } else {
                // Lower-thirds styling for full verse.
                document.querySelector("#song").classList.add("full-verse");
                document.querySelector("#song .text").textContent = song.stanza;
                textFit(document.querySelector('#song'), {maxFontSize: 44});
            }
        }

        function displayText(data) {
            clearText();
            var text = JSON.parse(event.data);
            if (text.bible !== undefined) {
             displayBible(text.bible);
            } else if (text.song !== undefined) {
             displaySong(text.song);
            }
        }

        function initWebSocket() {
            try {
                if (typeof MozWebSocket == 'function')
                    WebSocket = MozWebSocket;
                if ( websocket && websocket.readyState == 1 )
                    websocket.close();
                websocket = new WebSocket( wsUri );
                websocket.onmessage = function (event) {
                    displayText(event.data);
                };
                websocket.onerror = function (evt) {
                    console.log('ERROR: ' + evt.data);
                };
            } catch (exception) {
                console.log('ERROR: ' + exception);
            }
        }

        function stopWebSocket() {
            if (websocket)
                websocket.close();
        }

        window.onload = (event) => {
            initWebSocket();
        };
    </script>
</body>
</html>
