<!--/***************************************************************************
//
//    softProjector - an open source media projection software
//    Copyright (C) 2023  Vladislav Kobzar
//
//    This program is free software: you can redistribute it and/or modify
//    it under the terms of the GNU General Public License as published by
//    the Free Software Foundation version 3 of the License.
//
//    This program is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License
//    along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
***************************************************************************/-->

<html>

<head>
    <title></title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <!-- Style for projector
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=block');

        * {
            margin: 0;
            padding: 0;
        }

        body {
            width: 1860px;
            height: 1040px;
            padding: 20px 30px;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            position: relative;
        }

        p {
            margin: 0;
            color: #fff;
            text-shadow: 3px 3px 1px #000;
            white-space: pre-wrap;
            /* For the line breaks in song text */
        }

        #bible {
            flex-direction: column;
            height: 1040px;
            width: 1860px;
            display: flex;
            position: absolute;
            top: 20px;
            right: 30px;
            bottom: 20px;
            left: 20px;
        }

        #bible #primary,
        #bible #secondary {
            flex-basis: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 520px;
            width: 1860px;
        }

        #bible .text {
            margin-bottom: 8px;
        }

        #bible .reference {
            text-align: right;
            font-size: 70px;
        }

        #song {
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 1040px;
            width: 1860px;
            display: flex;
        }

        #song .textFitted {
            /* Last indicator position */
            position: relative;
            height: 100%;
            display: flex !important;
            align-items: center;
        }

        #last-indicator {
            position: absolute;
            right: 0;
            left: 0;
            bottom: 0;
            z-index: -1;
            font-size: 0.6em;
        }

        #song-translation {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 122px;
            width: 1860px;
            position: absolute;
            right: 0;
            left: 0;
            bottom: 0;
            margin: 0 auto;
        }

        #song-translation p {
            white-space: normal;
        }

        #song-translation-divider {
            border-top: 3px solid #000;
            position: absolute;
            right: 0;
            left: 0;
            bottom: 0;
            height: 122px;
            width: 1920px;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .fadeIn {
            animation-name: fadeIn;
            animation-duration: 0.5s;
            animation-fill-mode: forwards;
        }

        .fadeOut {
            animation-name: fadeOut;
            animation-duration: 0.5s;
            animation-fill-mode: forwards;
        }
    </style> -->

    <!-- Style for stream (lower third)
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=block');
        * {
            margin: 0;
            padding: 0;
        }
        body {
            width: 1860px;
            height: 1040px;
            padding: 20px 30px;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        p {
            margin: 0;
            color: #fff;
            text-shadow: 3px 3px 1px #000;
            white-space: pre-wrap;
        }

        #primary {
            display: none;
        }

        #bible, #song {
            align-self: flex-end;
            display: flex;
            flex-direction: column;
        }

        #bible #secondary {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 416px;
            width: 1860px;
        }

        #bible {
            height: 416px;
            width: 1860px;
            font-weight: 700;
            position: absolute;
            right: 30px;
            bottom: 20px;
            left: 20px;
        }

        #bible .text {
            margin-bottom: 8px;
        }

        #bible .reference {
            text-align: right;
            font-size: 60px;
        }

        #song {
            height: 1040px;
            width: 1860px;
            font-weight: 400;
            letter-spacing: 2px;
        }

        #song.full-verse {
           justify-content: flex-end;
           letter-spacing: 4px;
        }

        #song.full-verse p {
            line-height: 1.25;
            white-space: pre;
        }

        #song.verse-split {
            justify-content: flex-end;
        }

        #song.verse-split .textFitted {
            min-height: 215px;
        }

        #song.verse-split .text {
            text-align: center;
        }

        #song.verse-split p {
            line-height: 1.1;
            white-space: pre;
        }

        #last-indicator {
            display: none;
        }

        #song-split-translation {
            display: flex;
            height: 100px;
            width: 1860px;
            text-align: center;
            justify-content: center;
            align-items: flex-end;
            position: absolute;
            right: 0;
            left: 0;
            bottom: 20px;
            margin: 0 auto;
        }

        #song-split-translation p {
            white-space: normal;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .fadeIn {
            animation-name: fadeIn;
            animation-duration: 0.5s;
            animation-fill-mode: forwards;
        }

        .fadeOut {
            animation-name: fadeOut;
            animation-duration: 0.5s;
            animation-fill-mode: forwards;
        }
    </style> -->
</head>

<body>
    <div id="bible">
        <div id="primary">
            <p class="text">&nbsp;&nbsp;&nbsp;&nbsp;</p>
            <p class="reference">&nbsp;&nbsp;</p>
        </div>
        <div id="secondary">
            <p class="text">&nbsp;&nbsp;&nbsp;&nbsp;</p>
            <p class="reference">&nbsp;&nbsp;</p>
        </div>
    </div>
    <div id="song">
        <p class="text"></p>
        <p id="last-indicator" style="visibility: hidden;">*&nbsp;&nbsp;*&nbsp;&nbsp;*</p>
    </div>
    <div id="song-translation-divider"></div>
    <div id="song-translation">
        <p class="text"></p>
    </div>
    <div id="song-split-translation">
        <p class="text"></p>
    </div>

    <script>(function (root, factory) { "use strict"; if (typeof define === "function" && define.amd) { define([], factory) } else if (typeof exports === "object") { module.exports = factory() } else { root.textFit = factory() } })(typeof global === "object" ? global : this, function () { "use strict"; var defaultSettings = { alignVert: false, alignHoriz: false, multiLine: false, detectMultiLine: true, minFontSize: 6, maxFontSize: 80, reProcess: true, widthOnly: false, alignVertWithFlexbox: false }; return function textFit(els, options) { if (!options) options = {}; var settings = {}; for (var key in defaultSettings) { if (options.hasOwnProperty(key)) { settings[key] = options[key] } else { settings[key] = defaultSettings[key] } } if (typeof els.toArray === "function") { els = els.toArray() } var elType = Object.prototype.toString.call(els); if (elType !== "[object Array]" && elType !== "[object NodeList]" && elType !== "[object HTMLCollection]") { els = [els] } for (var i = 0; i < els.length; i++) { processItem(els[i], settings) } }; function processItem(el, settings) { if (!isElement(el) || !settings.reProcess && el.getAttribute("textFitted")) { return false } if (!settings.reProcess) { el.setAttribute("textFitted", 1) } var innerSpan, originalHeight, originalHTML, originalWidth; var low, mid, high; originalHTML = el.innerHTML; originalWidth = innerWidth(el); originalHeight = innerHeight(el); if (!originalWidth || !settings.widthOnly && !originalHeight) { if (!settings.widthOnly) throw new Error("Set a static height and width on the target element " + el.outerHTML + " before using textFit!"); else throw new Error("Set a static width on the target element " + el.outerHTML + " before using textFit!") } if (originalHTML.indexOf("textFitted") === -1) { innerSpan = document.createElement("span"); innerSpan.className = "textFitted"; innerSpan.style["display"] = "inline-block"; innerSpan.innerHTML = originalHTML; el.innerHTML = ""; el.appendChild(innerSpan) } else { innerSpan = el.querySelector("span.textFitted"); if (hasClass(innerSpan, "textFitAlignVert")) { innerSpan.className = innerSpan.className.replace("textFitAlignVert", ""); innerSpan.style["height"] = ""; el.className.replace("textFitAlignVertFlex", "") } } if (settings.alignHoriz) { el.style["text-align"] = "center"; innerSpan.style["text-align"] = "center" } var multiLine = settings.multiLine; if (settings.detectMultiLine && !multiLine && innerSpan.scrollHeight >= parseInt(window.getComputedStyle(innerSpan)["font-size"], 10) * 2) { multiLine = true } if (!multiLine) { el.style["white-space"] = "nowrap" } low = settings.minFontSize; high = settings.maxFontSize; var size = low; while (low <= high) { mid = high + low >> 1; innerSpan.style.fontSize = mid + "px"; if (innerSpan.scrollWidth <= originalWidth && (settings.widthOnly || innerSpan.scrollHeight <= originalHeight)) { size = mid; low = mid + 1 } else { high = mid - 1 } } if (innerSpan.style.fontSize != size + "px") innerSpan.style.fontSize = size + "px"; if (settings.alignVert) { addStyleSheet(); var height = innerSpan.scrollHeight; if (window.getComputedStyle(el)["position"] === "static") { el.style["position"] = "relative" } if (!hasClass(innerSpan, "textFitAlignVert")) { innerSpan.className = innerSpan.className + " textFitAlignVert" } innerSpan.style["height"] = height + "px"; if (settings.alignVertWithFlexbox && !hasClass(el, "textFitAlignVertFlex")) { el.className = el.className + " textFitAlignVertFlex" } } } function innerHeight(el) { var style = window.getComputedStyle(el, null); return el.clientHeight - parseInt(style.getPropertyValue("padding-top"), 10) - parseInt(style.getPropertyValue("padding-bottom"), 10) } function innerWidth(el) { var style = window.getComputedStyle(el, null); return el.clientWidth - parseInt(style.getPropertyValue("padding-left"), 10) - parseInt(style.getPropertyValue("padding-right"), 10) } function isElement(o) { return typeof HTMLElement === "object" ? o instanceof HTMLElement : o && typeof o === "object" && o !== null && o.nodeType === 1 && typeof o.nodeName === "string" } function hasClass(element, cls) { return (" " + element.className + " ").indexOf(" " + cls + " ") > -1 } function addStyleSheet() { if (document.getElementById("textFitStyleSheet")) return; var style = [".textFitAlignVert{", "position: absolute;", "top: 0; right: 0; bottom: 0; left: 0;", "margin: auto;", "display: flex;", "justify-content: center;", "flex-direction: column;", "}", ".textFitAlignVertFlex{", "display: flex;", "}", ".textFitAlignVertFlex .textFitAlignVert{", "position: static;", "}"].join(""); var css = document.createElement("style"); css.type = "text/css"; css.id = "textFitStyleSheet"; css.innerHTML = style; document.body.appendChild(css) } });</script>

    <script type="text/javascript">
        var wsUri = "ws://${ipAddress}:${webSocketPort}";
        var websocket = null;
        var fadeOut;
        var showingSong = false;
        var searchParams = new URLSearchParams(window.location.search);
        var songOnly = searchParams.has('songOnly');        
        var bibleOnly = searchParams.has('bibleOnly');

        function clearText() {
            document.querySelector("#bible").classList.add('fadeOut');
            document.querySelector("#bible").classList.remove('fadeIn');
            document.querySelector("#song").classList.add('fadeOut');
            document.querySelector("#song").classList.remove('fadeIn');
            document.querySelector("#song-translation-divider").classList.add('fadeOut');
            document.querySelector("#song-translation-divider").classList.remove('fadeIn');
            document.querySelector("#song-translation").classList.add('fadeOut');
            document.querySelector("#song-translation").classList.remove('fadeIn');
            document.querySelector("#song-split-translation").classList.add('fadeOut');
            document.querySelector("#song-split-translation").classList.remove('fadeIn');

            fadeOut = setTimeout(function() {
                document.querySelector("#bible #primary .text").textContent = "";
                document.querySelector("#bible #primary .reference").textContent = "";
                document.querySelector("#bible #secondary .text").textContent = "";
                document.querySelector("#bible #secondary .reference").textContent = "";
                document.querySelector("#song .text").textContent = "";
                document.querySelector("#song-translation .text").textContent = "";
                document.querySelector("#song-split-translation .text").textContent = "";
                document.querySelector("#song #last-indicator").style.visibility = "hidden";
                document.querySelector("#song").classList.remove("full-verse", "verse-split");             
            }, 500);
        }

        function displayBible(bible) {
            document.querySelector("#song").classList.add('fadeOut');
            document.querySelector("#song-translation-divider").classList.add('fadeOut');
            document.querySelector("#song-translation").classList.add('fadeOut');
            document.querySelector("#song-translation").classList.remove('fadeIn');
            document.querySelector("#song-split-translation ").classList.add('fadeOut');
            if (window.getComputedStyle(document.querySelector('#primary')).display !== 'none') {
                document.querySelector("#bible #primary .text").textContent = bible.primary.verse;
                document.querySelector("#bible #primary .reference").textContent = bible.primary.reference;
                textFit(document.querySelector('#primary'), { maxFontSize: 82 });
            }
            if (window.getComputedStyle(document.querySelector('#secondary')).display !== 'none') {
                document.querySelector("#bible #secondary .text").textContent = bible.secondary.verse;
                document.querySelector("#bible #secondary .reference").textContent = bible.secondary.reference;
                textFit(document.querySelector('#secondary'), { maxFontSize: 82 });
            }
            document.querySelector("#bible").classList.remove('fadeOut');
            document.querySelector("#bible").classList.add('fadeIn');
        }

        function displaySong(song) {
            document.querySelector("#bible").classList.add('fadeOut');
            if (window.getComputedStyle(document.querySelector('#last-indicator')).display !== 'none') {
                // Projector styling.
                if (!!song.splitTranslation) {
                    document.querySelector("body").style.paddingBottom = "0px";
                    document.querySelector("body").style.height = "1060px";

                    if (song.splitTranslation.length <= 162) {
                        // One or two lines of text box height.
                        document.querySelector("#song").style.height = "937px";
                        document.querySelector("#song-translation").style.height = "122px";
                        document.querySelector("#song-translation-divider").style.height = "122px";
                    } else {
                        // Approx three lines, bigger text box.
                        document.querySelector("#song").style.height = "878px";
                        document.querySelector("#song-translation").style.height = "181px";
                        document.querySelector("#song-translation-divider").style.height = "181px";
                    }

                    document.querySelector("#song-translation .text").textContent = song.splitTranslation;
                    textFit(document.querySelector('#song-translation'), { maxFontSize: 50 });
                    
                    if (!showingSong) {
                        // Fade in divider only on initial load.
                        document.querySelector("#song-translation").classList.add('fadeIn');
                        document.querySelector("#song-translation-divider").classList.add('fadeIn');
                    }
                    document.querySelector("#song-translation").classList.remove('fadeOut');
                    document.querySelector("#song-translation-divider").classList.remove('fadeOut');
                    document.querySelector("#song-translation-divider").style.display = "block";
                } else {
                    // Projector styling no translation.
                    document.querySelector("body").style.height = "1040px";
                    document.querySelector("body").style.paddingBottom = "20px";
                    document.querySelector("#song").style.height = "1040px";
                    document.querySelector("#song-translation .text").textContent = "";

                    document.querySelector("#song-translation-divider").classList.remove('fadeOut');
                    document.querySelector("#song-translation-divider").classList.remove('fadeIn');
                    document.querySelector("#song-translation-divider").style.display = "none";
                }
                document.querySelector("#song .text").textContent = song.verse;
                textFit(document.querySelector('#song'), { maxFontSize: 95 });
                document.querySelector("#song #last-indicator").style.visibility = (!!song.isLast ? "visible" : "hidden");
            } else if (song.split.length != 0) {
                // Lower-thirds styling for verse split.
                document.querySelector("#song").style.height = "940px";

                document.querySelector("#song").classList.add("verse-split");
                document.querySelector("#song").classList.remove("full-verse");
                document.querySelector("#song .text").textContent = song.split;
                textFit(document.querySelector('#song'), { maxFontSize: 65 });

                document.querySelector("#song-split-translation .text").textContent = song.splitTranslation;
                if (!showingSong) {
                    // Fade in divider only on initial load.
                    document.querySelector("#song-split-translation ").classList.add('fadeIn');
                }
                document.querySelector("#song-split-translation ").classList.remove('fadeOut');
                // document.querySelector("#song-split-translation").style.display = "flex";
                textFit(document.querySelector('#song-split-translation'), { maxFontSize: 36 });
            } else {
                // Lower-thirds styling for full verse.
                document.querySelector("#song").style.height = "1040px";
                document.querySelector("#song").classList.add("full-verse");
                document.querySelector("#song").classList.remove("verse-split");
                document.querySelector("#song .text").textContent = song.verse;
                textFit(document.querySelector('#song'), { maxFontSize: 44 });
                document.querySelector("#song").classList.remove('fadeOut');
                document.querySelector("#song").classList.add('fadeIn');

                document.querySelector("#song-split-translation").classList.remove('fadeOut');
                document.querySelector("#song-split-translation").classList.remove('fadeIn');
                document.querySelector("#song-split-translation .text").textContent = "";
                // document.querySelector("#song-split-translation").style.display = "none";
            }

            document.querySelector("#song").classList.remove('fadeOut');
            document.querySelector("#song").classList.add('fadeIn');
        }

        function displayText(data) {
            var text = JSON.parse(event.data);
            if (text.bible !== undefined && !songOnly) {
                clearTimeout(fadeOut);
                displayBible(text.bible);
                showingSong = false;
            } else if (text.song !== undefined && !bibleOnly) {
                clearTimeout(fadeOut);
                displaySong(text.song);
                showingSong = true;
            } else {
                clearText();
                showingSong = false;
            }
        }

        function initWebSocket() {
            try {
                if (typeof MozWebSocket == 'function')
                    WebSocket = MozWebSocket;
                if (websocket && websocket.readyState == 1)
                    websocket.close();
                websocket = new WebSocket(wsUri);
                websocket.onmessage = function (event) {
                    displayText(event.data);
                };
                websocket.onerror = function (evt) {
                    console.log('ERROR: ' + evt.data);
                };
            } catch (exception) {
                console.log('ERROR: ' + exception);
            }
        }

        function stopWebSocket() {
            if (websocket)
                websocket.close();
        }

        window.onload = (event) => {
            initWebSocket();
        };
    </script>
</body>

</html>
